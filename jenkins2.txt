pipeline {
    agent any
    stages {
        stage('Stage 1') {
            steps {
                script {
                    // Initialize a paragraph
                    def paragraph = "Initial content"
                    // Store the paragraph in an environment variable for later stages to access
                    env.PARAGRAPH = paragraph
                }
            }
        }
        stage('Parallel Stage') {
            parallel {
                stage('Stage 2') {
                    steps {
                        lock('paragraph-lock') {
                            script {
                                def stageNumber = 2
                                def paragraph = env.PARAGRAPH
                                paragraph += "\nContent added by Stage ${stageNumber}"
                                env.PARAGRAPH = paragraph
                            }
                        }
                    }
                }
                stage('Stage 3') {
                    steps {
                        lock('paragraph-lock') {
                            script {
                                def stageNumber = 3
                                def paragraph = env.PARAGRAPH
                                paragraph += "\nContent added by Stage ${stageNumber}"
                                env.PARAGRAPH = paragraph
                            }
                        }
                    }
                }
                stage('Stage 4') {
                    steps {
                        lock('paragraph-lock') {
                            script {
                                def stageNumber = 4
                                def paragraph = env.PARAGRAPH
                                paragraph += "\nContent added by Stage ${stageNumber}"
                                env.PARAGRAPH = paragraph
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            milestone()
        }
    }
}
import os
import os
import subprocess
from pathlib import Path

class CloudDeploy:
    def __init__(self):
        self.setup_env()

    @property
    def user(self):
        return os.getenv('USER', 'default_user')

    @property
    def hostname(self):
        return os.getenv('HOSTNAME', 'localhost')

    @property
    def cinitccname(self):
        return os.getenv('CINITCCNAME', f"/var/spool/certs/{self.user}")

    @cinitccname.setter
    def cinitccname(self, value):
        os.environ['CINITCCNAME'] = value

    @property
    def docker_host(self):
        return os.getenv('DOCKER_HOST', f"tcp://{self.hostname}:2376")

    @property
    def docker_tls_verify(self):
        return os.getenv('DOCKER_TLS_VERIFY', '1')

    @property
    def docker_cert_path(self):
        return os.getenv('DOCKER_CERT_PATH', f"{self.cinitccname}")

    @property
    def ticket_path(self):
        return Path(f"/var/spool/tickets/{self.user}")

    @property
    def workspace(self):
        workspace_dir = "/var/tmp/k8s-cloud-deploy"
        if not os.path.exists(workspace_dir):
            os.makedirs(workspace_dir)
        os.environ['WORKSPACE'] = workspace_dir
        return workspace_dir

    @property
    def cloud_deploy_version(self):
        return os.getenv('CLOUD_DEPLOY_VERSION', '2024.05.16-89')

    @property
    def mongo_connection_string(self):
        default_mongo_string = (
            f"mongodb://ivapp1388351.devin1.ms.com:27000,"
            f"ivapp1388352.devin1.ms.com:27000,ivapp1388353.devin1.ms.com:27000/"
            f"d_cloud-deploy?replicaSet=rs&tls=true&tlsCertificateKeyFile="
            f"{self.cinitccname}/combined-cert-key.pem&tlsCAFile=/etc/ssl/certs/ca-bundle.crt&authMechanism=MONGODB-X509"
        )
        return os.getenv('CLOUD_DEPLOY_CONNECTION_STRING', default_mongo_string)

    def setup_env(self):
        if self.ticket_path.is_file() and self.ticket_path.stat().st_size > 0:
            self.cinitccname = f"/var/spool/certs/{self.user}"
        else:
            if self.user:
                self.cinitccname = f"/var/spool/certs/{self.user}"
            else:
                print("Error: Unable to determine the current user.")
                exit(1)

        # Ensure CINITCCNAME directory exists
        cinitccname_path = Path(self.cinitccname)
        if not cinitccname_path.is_dir():
            print(f"Error: {self.cinitccname} must exist to get client certs.")
            exit(1)

        os.environ['DOCKER_TLS_VERIFY'] = self.docker_tls_verify
        os.environ['DOCKER_HOST'] = self.docker_host
        os.environ['DOCKER_CERT_PATH'] = self.cinitccname

    def run_docker_command(self, cmd):
        try:
            subprocess.run(cmd, shell=True, check=True)
        except subprocess.CalledProcessError as e:
            if "error during connect" in e.stderr:
                print("Error: Could not connect to Docker daemon. Please ensure Docker is running and accessible.")
            else:
                print(f"Error executing command: {e}")

    def status(self, container_name):
        cmd = f"docker inspect --format '{{{{.State.Running}}}}' {container_name}"
        status_result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        if status_result.stdout.strip() == 'true':
            print(f"Container {container_name} is running.")
            return True
        else:
            print(f"Container {container_name} is stopped.")
            return False

    def start(self, container_name, worker_concurrency, label, mongo_connection_string):
        if self.status(container_name):
            print(f"Container {container_name} is already running.")
            return
        cmd = (
            f"docker run -d --name {container_name} "
            f"--cap-drop=NET_BIND_SERVICE "
            f"--cap-drop=SETGID "
            f"--cap-drop=SETUID "
            f"-e CINITCCNAME={self.cinitccname} "
            f"-e CLOUD_DEPLOY_K8S_BASELINE_IMAGE=cloud/k8s-baseline "
            f"-e CLOUD_DEPLOY_CONNECTION_STRING='{mongo_connection_string}' "
            f"-e CLOUD_DEPLOY_SSL_CLIENT_CERT_FILE={self.cinitccname}/cert.pem "
            f"-e CLOUD_DEPLOY_SSL_CLIENT_CERT_KEY_FILE={self.cinitccname}/combined-cert-key.pem "
            f"-e CLOUD_DEPLOY_SSL_CLIENT_KEY_FILE={self.cinitccname}/key.pem "
            f"-e CLOUD_DEPLOY_K8S_WORKSPACE_DIR={self.workspace} "
            f"-e 'CLOUD_DEPLOY_WORKER_LABELS=[\"{label}\"]' "
            f"-e USER={self.user} "
            f"-e CLOUD_DEPLOY_WORKER_CONCURRENCY={worker_concurrency} "
            f"--network=host "
            f"--security-opt=no-new-privileges "
            f"-u {os.getuid()}:{os.getgid()} "
            f"-v {self.cinitccname}:{self.cinitccname}:ro "
            f"-v {self.workspace}:{self.workspace}:rw "
            f"-v /etc/nsswitch.conf:/etc/nsswitch.conf:ro "
            f"-v /var/db:/var/db:ro "
            f"msde/cloud-deploy:{self.cloud_deploy_version} "
            f"bin/run-worker.sh"
        )
        print("DEBUG DEBUG DEBUG DEBUG DEBUG DEBUG")
        print(cmd)
        self.run_docker_command(cmd)

    def stop(self, container_name):
        if not self.status(container_name):
            print(f"Container {container_name} is already stopped.")
            return
        self.run_docker_command(f"docker stop {container_name}")
        print(f"Container {container_name} is stopped.")

    def restart(self, container_name, worker_concurrency, label, mongo_connection_string):
        if not self.status(container_name):
            print(f"Container {container_name} is stopped. Starting it...")
            self.start(container_name, worker_concurrency, label, mongo_connection_string)
        else:
            self.run_docker_command(f"docker restart {container_name}")
            print(f"Container {container_name} is restarted.")

if __name__ == "__main__":
    action = input("Enter action (start/stop/restart): ").strip().lower()
    container_name = input("Enter container name: ").strip()
    worker_concurrency = input("Enter worker concurrency: ").strip()
    label = input("Enter label: ").strip()

    cloud_deploy = CloudDeploy()

    if action == "start":
        mongo_connection_string = input("Enter MongoDB connection string: ").strip()
        cloud_deploy.start(container_name, worker_concurrency, label, mongo_connection_string)
    elif action == "stop":
        cloud_deploy.stop(container_name)
    elif action == "restart":
        mongo_connection_string = input("Enter MongoDB connection string: ").strip()
        cloud_deploy.restart(container_name, worker_concurrency, label, mongo_connection_string)
    else:
        print(f"Unknown action: {action}")
